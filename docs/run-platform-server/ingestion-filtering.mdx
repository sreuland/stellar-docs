---
title: Ingestion Filtering
order: 46
---

## Overview

Ingestion Filtering enables Horizon operators to drastically reduce the storage footprint of the historical data in the Horizon database by allow-listing Assets and/or Accounts that are relevant to their operations.

### Why is it useful:

Previously, the only way to limit data storage was by limiting the temporal range of history via rolling retention (e.g. the last 30 days). The filtering feature allows users to store a longer historical timeframe in the Horizon database for only whitelisted assets, accounts, and their related historical entities (transactions, operations, trades, etc.).

For further context, running an unfiltered `full` history Horizon instance currently requires over 30TB of disk space (as of June 2023) with storage growing at a rate of about 1TB/month. As a benchmark, filtering by even 100 of the most active accounts and assets reduces storage by over 90%. For the majority of applications which are interested in an even more limited set of assets and accounts, storage savings should be well over 99%. Other benefits include reducing operating costs for maintaining storage, improved DB health metrics and query performance.

### How does it work:

Filtering feature operates during the ingestion process, **live** or **prior historical ranges**. It tells ingestion process to only accept incoming ledger transactions which match on a filter rule, any transactions which don't match on filter rules are skipped by ingestion and therefore not stored on database.

Some key aspects to note about filtering behavior:

- Filtering applies only to ingestion of historical data in the database, it does not affect how ingestion process maintains current state data stored in database, which is the last known ledger entry for each unique entity within accounts, trustlines, liquidity pools, offers. However, current state data consumes a relatively small amount of the overall storage capacity.
- When filter rules are changed, they only apply to active ingestion processes(**live** or **historical ranges**). They don't trigger any retro-active filtering or back-filling of existing historical data on the database.
  - If you update the filter rules to increase allow-listing of accounts or assets, related transactions will only start to show up in historical database data from **live** ingestion beginning after time the filter rule is updated using the Horizon Admin API. Same applies to **historical range** ingestion, it will only be affected by new filter rules starting at current ledger it was processing within it's configured range at time the filter rules were updated.
  - When updating filter rules with increased allow list coverage, no historical back-filling is done automatically. You can manually backfill the history on database by running a new **historical range** ingestion process for a past ledger range after you have updated the filter rules to achieve that result.
  - If you update filter rules and reduce the allow list coverage by removing some entities, no retro-active purging or filtering of historical data per the reduced scope of filter rules on database is performed. Whatever data is stored on history tables resides for lifetime of database or until `HISTORY_RETENTION_COUNT` is exceeded, and Horizon will purge all historical data for all entites related to older ledgers regardless of any filtering rules.
- Filtering will not affect the performance or throughput rate of an ingestion process, it will remain consistent whether filter rules are present or not.

Filter rules define allow-lists for the following supported entities:

- Account id
- Asset id (canonical)

Given that all transactions related to the white listed entities are included, all historical time series data related to those transactions are saved in horizon's history db, including transaction itself, all operations in the transaction, and references to any ancillary entities from operations.

## Configuration:

Filtering is enabled by default but with no filter rules, which effectively means no filtering of ingested data occurs. To start filtering ingestion:

- enable Horizon admin port with environmental configuration parameter `ADMIN_PORT=XXXXX`, this will allow you to access the port.
- define filter whitelists. submit Admin HTTP API requests to view and update the filter rules:

  Refer to the [Horizon Admin API Docs](https://github.com/stellar/go/blob/master/services/horizon/internal/httpx/static/admin_oapi.yml) which are also published on Horizon instance as Open API 3.0 doc on the Admin Port at `http://localhost:<admin_port>/`. You can paste the contents from that url into any OAPI tool such as [Swagger](https://editor.swagger.io/) which will render a visual explorer of the API endpoints. Follow details and example request/response payloads for these filter rule endpoints:

  ```
  /ingestion/filters/account
  /ingestion/filters/asset
  ```

### Gap fill on filtered historical data:

If new Assets or Accounts are added to the whitelist rules and you would like to pull in their missing historical data which would have been dropped earlier, you need to run reingestion. The Reingestion process is idempotent and will re-ingest the data from the designated historical ledger range and `upsert` to Horizon historical data, i.e. overwrite or insert new data not already in the current database.

## Sample Use Case:

As an Asset Issuer, I have issued 4 assets and am interested in all transaction data related to those assets including customer Accounts that interact with those assets and the following:

- Operations
- Effects
- Payments
- Claimable balances
- Trades

I would like to store the full history of all transactions related from the genesis of those assets.

### Pre-requisites:

You have installed Horizon with empty database and it has **live** ingestion enabled.

### Steps:

1. Configure a filter rule with 4 whitelisted Assets via the Admin API.

2. If you do not need prior historical data to the present time, you can effectively stop here, anytime changes or enablement of filter rules are done, the history tables will immediately reflect filtered data per those latest rules from the time the filter rule is updated and onward.

3. Perform a separate historical [reingestion](ingestion.mdx#ingesting-historical-data) specifying a range with the earliest ledger # in network history that you want retained for the whitelisted entities.
