---
title: Ingestion Filtering
order: 46
---

## Overview

Ingestion Filtering enables Horizon operators to drastically reduce the storage footprint of the historical data in the Horizon database by whitelisting Assets and/or Accounts that are relevant to their operations.

### Why is it useful:

Previously, the only way to limit data storage was by limiting the temporal range of history via rolling retention (e.g. the last 30 days). The filtering feature allows users to store a longer historical timeframe in the Horizon database for only whitelisted assets, accounts, and their related historical entities (transactions, operations, trades, etc.).

For further context, running a non-filtered `full` history Horizon instance currently takes ~ 25TB of disk space (as of June 2023) with storage growing at a rate of ~ 1TB / month. As a benchmark, filtering by even 100 of the most active accounts and assets reduces storage by over 90%. For the majority of applications which are interested in an even more limited set of assets and accounts, storage savings should be well over 99%. Other benefits are reducing operating costs for maintaining storage, improved DB health metrics and query performance.

### How does it work:

This feature operates by accepting only ledger transactions that match a filter rule when persisting the transactions and operations to historical tables in the Horizon database at ingestion time, any entries that don't match are skipped and not stored on database.

Note that this filtering applies only to historical data, and does not affect current state data stored in Horizon. However, current state data consumes a relatively small amount of the overall storage capacity.

Filter rules can whitelist ingestion by the following supported entities:

- Account id
- Asset id (canonical)

Given that all transactions related to the white listed entities are included, all historical time series data related to those transactions are saved in horizon's history db, including transaction itself, all operations in the transaction, and references to any ancillary entities from operations.

## Configuration:

Filtering is enabled by default but with no filter rules, which effectively means no filtering of ingested data occurs. To start filtering ingestion:

- enable Horizon admin port with environmental configuration parameter `ADMIN_PORT=XXXXX`, this will allow you to access the port.
- define filter whitelists. submit Admin HTTP API requests to view and update the filter rules:

  Refer to the [Horizon Admin API Docs](https://github.com/stellar/go/blob/master/services/horizon/internal/httpx/static/admin_oapi.yml) which are also published on Horizon instance as Open API 3.0 doc on the Admin Port at `http://localhost:<admin_port>/`. You can paste the contents from that url into any OAPI tool such as [Swagger](https://editor.swagger.io/) which will render a visual explorer of the API endpoints. Follow details and example request/response payloads for these filter rule endpoints:

  ```
  /ingestion/filters/account
  /ingestion/filters/asset
  ```

### Gap fill on filtered historical data:

If new Assets or Accounts are added to the whitelist rules and you would like to pull in their missing historical data which would have been dropped earlier, you need to run reingestion. The Reingestion process is idempotent and will re-ingest the data from the designated historical ledger range and `upsert` to Horizon historical data, i.e. overwrite or insert new data not already in the current database.

## Sample Use Case:

As an Asset Issuer, I have issued 4 assets and am interested in all transaction data related to those assets including customer Accounts that interact with those assets and the following:

- Operations
- Effects
- Payments
- Claimable balances
- Trades

I would like to store the full history of all transactions related from the genesis of those assets.

### Pre-requisites:

You have installed Horizon with empty database, it has **live** ingestion enabled.

### Steps:

1. Configure a filter rule with 4 whitelisted Assets via the Admin API.

2. If you do not need prior historical data to the present time, you can effectively stop here, anytime changes or enablement of filter rules are done, the history tables will immediately reflect filtered data per those latest rules from the time the filter rule is updated and onward.

3. Perform a separate historical [reingestion](ingestion.mdx#ingesting-historical-data) specifying a range with the earliest ledger # in network history that you want retained for the whitelisted entities.
