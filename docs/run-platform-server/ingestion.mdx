---
title: Ingestion
sidebar_position: 45
---

import { CodeExample } from "@site/src/components/CodeExample";

Horizon API provides most of its utility through ingested data, and your Horizon server can be configured to listen for and ingest transaction results from the Stellar network. Ingestion enables API access to both current (e.g. someone's balance) and historical state (e.g. someone's transaction history).

## Determine storage space

You should think carefully about the historical timeframe of ingested data you'd like to retain on Horizon's database, the storage requirements for the entire Stellar network are substantial and grow unbounded, increasing storage used by the Horizon database well into many terabytes, and is an unsustainable deployment. Most organizations and operators only need recent fractions of the historical data, to fit their use case. To Achieve minimal storage footprint, we recommend leveraging the following:

- [ingestion filter rules](./ingestion-filtering.mdx) based on accounts and assets related to your application space.
- temporal limits, if no filter rules are applied, we recommend limiting historical retention of ingested data to a sliding window of 1 month(`HISTORY_RETENTION_COUNT=518400`) and this is the [default set by Horizon](./configuring.mdx#ingestion-role-instance). This is based on metrics and trend analysis of our own API servers, we have seen most requests are for near term data.
  - for access to historical data more than 1 month old, we recommend not using Horizon's database for this purpose, instead consider usage of [Stellar Hubble Data Warehouse](https://www.stellar.org/developers-blog/try-our-new-analytics-dataset?locale=en).

## Ingestion Types

There are two primary ingestion use-cases for Horizon operations:

- ingesting **live** data to stay up to date with the latest, real-time changes to the Stellar network, and
- ingesting **historical** data to retroactively add network data from a time range in the past to the database.

### Ingesting Live Data

This option is enabled by default, it is controlled with flag `INGEST`. Refer to [Configuration](./configuring.mdx) for how an instance of Horizon performs the ingestion role.

For a H/A requirements, **we highly recommend having more than one live ingesting instance**, as this makes it easier to avoid downtime during upgrades and adds resilience to your infrastructure, ensuring you always have the latest network data, refer to [Ingestion Role Instance](./configuring.mdx#multiple-instance-deployment)

### Ingesting Historical Data

Import network data from a past date range in to the database:

<CodeExample>

```
stellar-horizon db reingest range <start> <end>
```

</CodeExample>

Running any historical range of ingestion requires coordination with the data retention configuration chosen. If you have a temporal limit on history set with `HISTORY_RETENTION_COUNT=<LEDGER_COUNT>` then it makes no sense to ingest any time range that is older as it will get purged from the database almose as soon as it's added.

Typically the only time you need to run historical ingestion is once when boot-strapping a system after first deployment, from that point forward **live** ingestion will keep the database populated with the expected sliding window of trailing historical data. Maybe one exception is if you think you have a gap in the database caused by the **live** ingestion being down, in which case you can run historical ingestion range to essentially gap fill.

You can run historical ingestion in parallel in background while your main Horizon server separately performs **live** ingestion. If the range specified overlaps with data already in the database, it will simply be overwritten, effectively idempotent.

#### Parallel ingestion workers

You can break up historical date range into slices and run each in parallel as a separate process:

<CodeExample>

```
horizon1> stellar-horizon db reingest range 1 10000
horizon2> stellar-horizon db reingest range 10001 20000
horizon3> stellar-horizon db reingest range 20001 30000
# ... etc.
```

</CodeExample>

### Notes

#### Some endpoints may report not available during **live** ingestion

Endpoints that display current state information from **live** ingestion may return `503 Service Unavailable`/`Still Ingesting` error. An example is the `/paths` endpoint (built using offers). Such endpoints will become available after **live** ingestion has finished network synchronization and catch up(usually within a couple of minutes).

#### If more than five minutes has elapsed with no new ingested data:

- Verify host machine meets recommended [Prerequisites](./prerequisites.mdx).

- Check horizon log output.
  - Are there many `level=error` messages, maybe an environmental issue, access to database is lost, etc.
  - **live** ingestion will emit two key log lines about once every 5 seconds based on latest ledger emitted from network. Tail the horizon log output and grep for presence of these lines with a filter:
  ```
  tail -f horizon.log | | grep -E 'Processed ledger|Closed ledger'
  ```
  If you don't see output from this pipeline every couple of seconds for a new ledger then ingestion is not proceeding, look at full logs and see if any alternative messages are printing reasons to the contrary. May see lines mentioning 'catching up' When connecting to pubnet, as it can take up to 5 minutes for the captive core process started by Horizon to catch up to pubnet network.
  - Check RAM usage on the machine. It's possible that system ran low on RAM and is using swap memory which will result in slow performance.
  - Verify the read/write throughput speeds on the volume that current working directory for horizon process is using. Volume should have at least 10mb/s, one way to roughly verify this on host command line:
  ```
  sudo dd if=/dev/zero of=/tmp/test_speed.img bs=1G count=1
  ```

#### Monitoring ingestion process

For high availability deployments, it is recommended to implement monitoring of ingestion process for visibility on performance/health. Refer to [Monitoring](./monitoring.mdx) for accessing logs and metrics from horizon. Stellar publishes the example [Horizon Grafana Dashboard](https://grafana.com/grafana/dashboards/13793-stellar-horizon/) which demonstrates queries against key horizon ingestion metrics, specifically look at the `Local Ingestion Delay` and `Last Ledger Age` in the `Health Summary` panel.
