---
title: Configuring
sidebar_position: 30
---

import { Alert } from "@site/src/components/Alert";
import { CodeExample } from "@site/src/components/CodeExample";

Pre-requisites:

- [Installation](./installing.mdx) is completed on a host machine and results in two executables: `stellar-horizon` and `stellar-core`. Per the installation instructions, `stellar-core` should be included in your host OS' `$PATH`, as the configurations below result in Horizon searching for a `stellar-core` to execute.
- [Prepare the Database if first time](#prepare-the-database-first-time)

You are now ready to setup configuration parameters to perform three important, distinct roles:

- **serving requests** via a regular web-based HTTP API,
- **ingesting ledgers** from core nodes of a Stellar network to keep its world-view up to date, and
- **transaction submission** for sending transactions to the Stellar network.

To perform these roles, you can choose from one of two of the deployment modes that follow. Each has its own configuration parameters.

<Alert>

In all configuration examples, the same parameter can be provided either as command line argument or an environment variable. If both are provided, the command line takes precedence.

</Alert>


## Single Instance Deployment

You run `stellar-horizon` in a single o/s process and it will perform all three roles at same time.

| flag               | envvar         | example                              |
| ------------------ | -------------- | ------------------------------------ |
| `--db-url`         | `DATABASE_URL` | postgres://localhost/horizon_testnet |
| `--network`        | `NETWORK`      | pubnet                               |
| `--log-level`      | `LOG_LEVEL`    | info                                 |
| `--tx-sub-enabled` | TX_SUB_ENABLED | true                                 |

## Multiple Instance Deployment

You run multiple instances of `stellar-horizon` each performs a subset of the roles.

### Ingestion Role Instance

You need to allocate one instance to perform ongoing ingestion to capture network activity. We recommend limiting the amount of network activity to retain in the db on a sliding window of the last 30 days, we include `--history-retention-count 518400` which is number of ledgers in 30 days. **TODO - make --history-retention-count default to 518400, don't specify here anymore. make --captive-core-use-db=true by default**

| flag | envvar | example |
| --- | --- | --- |
| `--db-url` | `DATABASE_URL` | postgres://localhost/horizon_testnet |
| `--history-retention-count` | `HISTORY_RETENTION_COUNT` | 518400 |
| `--network` | `NETWORK` | pubnet |
| `--log-level` | `LOG_LEVEL` | info |

### API Role Instance

You can run none or multiple instances to serve read only API requests. **TODO - create --tx-sub-enabled flag, default=false. Should return 405 on POSTs to /tx if enabled. this allows skipping need to define --stellar-core-url on api servers since instance doesn't need to be aware of core.**

| flag               | envvar           | example                              |
| ------------------ | ---------------- | ------------------------------------ |
| `--db-url`         | `DATABASE_URL`   | postgres://localhost/horizon_testnet |
| `--log-level`      | `LOG_LEVEL`      | info                                 |
| `--tx-sub-enabled` | `TX_SUB_ENABLED` | false                                |

### Transaction Submission Role Instance

You can run none or multiple instances to serve transaction submission requests. If you run an instance with transaction submission enabled, yuur deployment is required to perform the ingestion role on the same database referenced here. Horizon transaction submission depends on ingestion to confirm tx submission status. **TODO - Confirm Horizon can use captive core to send tx sub requests and skip stellar-core-url?. If --tx-sub-enabled=true, horizon should check at startup that ingestion is happening on it's db or exit startup with error.**

| flag | envvar | example |
| --- | --- | --- |
| `--db-url` | `DATABASE_URL` | postgres://localhost/horizon_testnet |
| `--network` | `NETWORK` | pubnet |
| `--log-level` | `LOG_LEVEL` | info |
| `--stellar-core-url` | STELLAR_CORE_URL | http://localhost:11626 |
| `--tx-sub-enabled` | `TX_SUB_ENABLED` | true |

## Notes

- If you have configured your deployment to perform the ingestion role, then it is **strongly** recommended to review [Ingestion](./ingestion.mdx) first for key features such as filtering and update your configuration accordingly to achieve best performance before proceeding further.

- `--network`, optional, can be one of Stellar's public networks, 'pubnet', or 'devnet'. Triggers horizon to automatically set configurations for remaining horizon settings and generate the correct core toml/cfg settings. If you only need Horizon to connect to one of those public Stellar networks, this will take care of all related configuration. **TODO - create this new flag and the functionality it performs to configure all aspects including toml, archive urls, etc for network 'pubnet' or 'testnet'**

- If you want to connect Horizon to a different stellar network or override any of the defaults that horizon will make, the key configurations that can be set are: `--history-archive-urls`, `--captive-core-config-path`, `--network-pass-phrase`, `--captive-core-storage-path`, `--stellar-core-url`.

- `--db-url`, required, specifies the Horizon database. It's value follows this format: `dbname=<pg_dbname> user=<pg_user_name> password=<pg_user_pwd> host=<host_address>`

- `--log-level`, optional, can be one of 'info', 'error', 'debug'.

- Horizon will create a sub-directory under the current working directory of the o/s process to store captive core runtime data files. Expect up to 10GB usage(**TODO - verify the max storage needs of core/buckets on disk?**). You can override this location with the optional `--captive-core-storage-path`, set to a directory on file system which captive core wiull store the runtime files.

### Passing configurations to Horizon

Depends on how Horizon was installed:

- bare-metal
  - non-package manager, we recommend using environment variables to pass configurations. There are many tools you can use to manage them, such as [direnv](http://direnv.net/) or [dotenv](https://github.com/bkeepers/dotenv).
  - [package manager](./installing.mdx#package-manager), the provided `stellar-horizon-cmd` wrapper will import a configuration from `/etc/default/stellar-horizon`, hence, if you want to set configurations, edit the file at `/etc/default/stellar-horizon`.
    <Alert>
      This script invokes Horizon with the `stellar` user, so make sure that
      permissions for the user are set up accordingly. The current working
      directory should be writable for this user and the user should be able to
      execute the `horizon` and `stellar-core` binaries; etc.
    </Alert>
- containerized
  - non-Helm, pass all configuration parameters to the horizon docker image as [docker environment variables](https://docs.docker.com/engine/reference/commandline/run/#env).
  - Helm, pass all configuration parameters in the [Helm Install command](https://helm.sh/docs/helm/helm_install/)

## Prepare the Database first time

Before running the Horizon server first time, you must initialize the Horizon database. This database will be used for all of the information produced by Horizon, most notably historical information about transactions that have occurred on the Stellar network.

To prepare a database for Horizon's use, first ensure it is blank. It's easiest to create a new database on your PostgreSQL server specifically for Horizon's use. We recommend creating a new user(role) in postgres dedicated for horizon's db and assigning that user(role) as the owner of the new horizon db. To illustrate this as example using `psql`, first login to databse server using the `psql` cli as a superuser, and then create the new user(role) and db for horizon:

```
postgres=#
postgres=# CREATE ROLE horizon WITH LOGIN;
CREATE ROLE
postgres=#
postgres=# CREATE DATABASE horizon OWNER horizon;
CREATE DATABASE
postgres=#
```

Additionally set a password on your new `horizon` user using `ALTER USER`.

Given this example, you can now complete the `DATABASE_URL="dbname=horizon user=horizon password=<value_here> host=<address_of_pg_server>" configuration parameter.

Next, use the Horizon binary to install the schema onto the empty db from command line:

```
$ export DATABASE_URL="dbname=horizon user=horizon password=<value_here> host=<address_of_pg_server>"
$ stellar-horizon db init --db-url

```

### Optional Postgres Configurations

Based on performance observations over time, we recommend additional Postgres configuration settings(postgresql.conf), but these are not required:

- Set `random_page_cost=1` if you are using SSD storage. With this setting, Query Planner will make a better use of indices, especially for `JOIN` queries. We've noticed a huge speed improvement for some queries with this setting.

\_ To improve availability of ingestion, api, transaction submission servers it's recommended to set the following values:

- `tcp_keepalives_idle`: 10 seconds
- `tcp_keepalives_interval`: 1 second
- `tcp_keepalives_count`: 5

With the config above, if there are no queries from a given client for 10 seconds, Postgres should start sending TCP keepalive packets. It will retry 5 times every second. If there is no response from the client after that time it will drop the connection.

## Next Step

After configuration is complete, you are now ready to proceed to [Running Horizon](./running.mdx)!
