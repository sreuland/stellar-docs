---
title: Configuring
sidebar_position: 30
---

import { Alert } from "@site/src/components/Alert";
import { CodeExample } from "@site/src/components/CodeExample";

Pre-requisites:

- [Installation](./installing.mdx) is completed on a host machine and results in two executables: `stellar-horizon` and `stellar-core`. Per the installation instructions, `stellar-core` should be included in your host OS' `$PATH`, as the configurations below result in Horizon searching for a `stellar-core` to execute.
- [Initialize Database](#initialize-horizon-database)

You are now ready to setup configuration parameters to perform three important, distinct roles:

- **serving requests** via a regular web-based HTTP API, and
- **ingesting ledgers** from core nodes of a Stellar network to keep its world-view up to date, and
- **transaction submission** for sending transactions to the Stellar network.

To perform these roles, you can choose from one of two of the deployment modes that follow. Each has its own configuration parameters.

## Single Instance Deployment

You run `stellar-horizon` in a single o/s process and it will perform all three roles at same time.

| environment variable      | example                             |
| ------------------------- | ----------------------------------- |
| `DATABASE_URL`            | postgres://localhost/horizon_pubnet |
| `NETWORK`                 | pubnet                              |
| `HISTORY_RETENTION_COUNT` | 518400                              |

## Multiple Instance Deployment

In this scalable deployment variant, you run multiple instances of `stellar-horizon` and each performs a subset of the roles. This allows you to horizontally scale each of the role functions independently.

### Ingestion Role Instance

You need to allocate **at least** one instance to perform ongoing ingestion to capture network activity. This will default to limiting storage of ingested network activity in the database to our recommendation of a sliding window of the last 30 days.

| environment variable      | example                             |
| ------------------------- | ----------------------------------- |
| `DATABASE_URL`            | postgres://localhost/horizon_pubnet |
| `NETWORK`                 | pubnet                              |
| `HISTORY_RETENTION_COUNT` | 518400                              |
| `TX_SUB_ENABLED`          | false                               |

### API Role Instance

You can run none or multiple instances to serve read only API requests. Notice there is no need to define network settings here, as Horizon only reads from database.

**TODO - create TX_SUB_ENABLED env variable, default=true. Should return 405 on POSTs to /tx if FALSE. If true, horizon should check at startup that ingestion is happening on it's db or exit startup with error. If TX_SUB_ENABLED=FALSE and INGEST=FALSE, should also allow skipping need to define `NETWORK` or `STELLAR_CORE_URL` since there is no need to be aware of core.**

| environment variable | example                             |
| -------------------- | ----------------------------------- |
| `DATABASE_URL`       | postgres://localhost/horizon_pubnet |
| `INGEST`             | false                               |
| `TX_SUB_ENABLED`     | false                               |

### Transaction Submission Role Instance

You can run none or multiple instances to serve transaction submission requests. If you run an instance with transaction submission enabled, your deployment is required to perform the ingestion role on the same database referenced here. Horizon transaction submission depends on **live** ingestion to confirm tx submission status.

If ingestion is planned to be done on a separate instance, add `INGEST=false` on this instance, otherwise don't include the parameter, Horizon will default to `INGEST=true` if absent.

If not using the `NETWORK` variable, then must provide the `STELLAR_CORE_URL` variable.

Refer to [Channel Accounts](../encyclopedia/channel-accounts.mdx) for some recommendations on client transaction submission optimizations.

**TODO - Confirm Horizon can use captive core to send tx sub requests and skip stellar-core-url?. **

| environment variable | example                             |
| -------------------- | ----------------------------------- |
| `DATABASE_URL`       | postgres://localhost/horizon_pubnet |
| `NETWORK`            | pubnet                              |
| `INGEST`             | false                               |

## Notes

- If you have configured your deployment to perform the ingestion role, then it is **strongly** recommended to review [Ingestion](./ingestion.mdx) first and [Filtering](./ingestion-filtering) second and factor that into configuration parameters to achieve best performance related to your application requirements before proceeding further.

- `TX_SUB_ENABLED`, optional, enabled as TRUE by default.

  - When enabled, requires **live** ingestion process to be running on the same database because Horizon depends on new ledgers from network to confirm a transaction submission status, Horizon will report startup error if it detects no **live** ingestion. Requires `NETWORK` or `STELLAR_CORE_URL` be defined for access to network.
  - When disabled with FALSE, Horizon will return 405 on POSTs to /tx.

- `NETWORK`, optional, can be one of Stellar's public networks, 'pubnet', or 'devnet'. Triggers horizon to automatically set configurations for remaining horizon settings and generate the correct core toml/cfg settings. If you only need Horizon to connect to one of those public Stellar networks, this will take care of all related configuration.

**TODO - create the new `NETWORK` env variable and the functionality it performs to configure all aspects of network connection, including toml, passphrase, archive urls, etc for networks 'pubnet' and 'testnet'. Refer to quickstart for example of same consolidated config parameter for setting network. **

- If you want to connect Horizon to a different stellar network other than pubnet or testnet or override any of the defaults that `NETWORK` usage will initiate, the key envrionment variables that can be set are: `HISTORY_ARCHIVE_URLS`, `CAPTIVE_CORE_CONFIG_PATH`, `NETWORK_PASSPHRASE`, `CAPTIVE_CORE_STORAGE_PATH`, `STELLAR_CORE_URL`.

- `DB_URL`, required, specifies the Horizon database. It's value follows this format: `dbname=<pg_dbname> user=<pg_user_name> password=<pg_user_pwd> host=<host_address>`

- `LOG_LEVEL`, optional, can be one of 'info', 'error', 'debug'.

- `HISTORY_RETENTION_COUNT`, optional, this determines the maximum sliding window of historical network data to retain on the database from ingestion. The value is expressed as absolute ledger count, which is an indirect way to define a duration of time, each ledger being approximately 5 seconds. It is defaulted to 0, which means it will not purge any history from database. To enact the recommended sliding window of one month, set this to 518400. Which is the approximate number of ledgers in 30 days. Refer to [Compute Resources](./prerequisites.mdx) for how database storage space is closely related to this setting.

- Horizon will create a sub-directory under the current working directory of the o/s process to store captive core runtime data files. Expect up to 10GB usage. You can override this location with the optional `CAPTIVE_CORE_STORAGE_PATH` environment variable, set to a directory on file system which captive core will store the runtime files.

**TODO - verify the max storage needs of core/buckets on disk, make sure to specify this on [prerequisites](./prerequisites.mdx) is 10GB enough ? **

### Passing configurations to Horizon

The `stellar-horizon` binary searches process environment variables for configuration. Depending on how Horizon was installed, the method you perform to configure the process environment will differ:

- bare-metal
  - non-package manager, use O/S environment variables to pass configurations. There are many tools you can use to manage them, such as [direnv](http://direnv.net/) or [dotenv](https://github.com/bkeepers/dotenv).
  - [package manager](./installing.mdx#package-manager), the provided `stellar-horizon-cmd` wrapper will start a new process and create environment variables in the process from `/etc/default/stellar-horizon` and then launch the 'stellar-horizon' in the process, hence, to set configurations, edit the file at `/etc/default/stellar-horizon`.
    <Alert>
      This script invokes Horizon with the `stellar` user, so make sure that
      permissions for the user are set up accordingly. The current working
      directory should be writable for this user and the user should be able to
      execute the `stellar-horizon` and `stellar-core` binaries; etc.
    </Alert>
- containerized
  - non-Helm, pass all configuration parameters to the horizon docker image as [docker environment variables](https://docs.docker.com/engine/reference/commandline/run/#env).
  - Helm, pass all configuration parameters in the [Helm Install command] as a values file.(https://helm.sh/docs/helm/helm_install/)

## Initialize Horizon Database

Before running the Horizon server first time, you must initialize the Horizon database. This database will be used for all of the information produced by Horizon, most notably historical information about transactions that have occurred on the Stellar network.

To prepare a database for Horizon's use, first ensure it is blank. It's easiest to create a new database on your PostgreSQL server specifically for Horizon's use. We recommend creating a new user(role) in postgres dedicated to Horizon's database and assigning that user(role) as the owner of this database.

To illustrate an example using `psql`, first login to database server using the `psql` command-line tool as a superuser, and then create the new user(role) and database for Horizon:

```
postgres=#
postgres=# CREATE ROLE horizon WITH LOGIN;
CREATE ROLE
postgres=#
postgres=# CREATE DATABASE horizon OWNER horizon;
CREATE DATABASE
postgres=#
```

Additionally, you can set a password on your new `horizon` postgres user with `ALTER USER`.

Once completed, you can compose the full value of configuration parameter for db access `DATABASE_URL="dbname=horizon user=horizon password=<value_here> host=<address_of_pg_server>"`.

Next, execute the Horizon binary to install the schema onto the empty db from the command line. In this example, assume the current shell doesn't have `DATABASE_URL` in environment yet, so export it first into shell:

```
$ export DATABASE_URL="dbname=horizon user=horizon password=<value_here> host=<address_of_pg_server>"
$ stellar-horizon db init
```

### Optional Postgres Configurations

Based on performance observations over time, we recommend additional Postgres configuration settings(postgresql.conf), but these are not required:

- Set `random_page_cost=1` if you are using SSD storage. With this setting, Query Planner will make a better use of indices, especially for `JOIN` queries. We've noticed a huge speed improvement for some queries with this setting.

\_ To improve availability of ingestion, api, transaction submission servers it's recommended to set the following values:

- `tcp_keepalives_idle`: 10 seconds
- `tcp_keepalives_interval`: 1 second
- `tcp_keepalives_count`: 5

With the config above, if there are no queries from a given client for 10 seconds, Postgres should start sending TCP keepalive packets. It will retry 5 times every second. If there is no response from the client after that time it will drop the connection.

## Next Step

After configuration is complete, you are now ready to proceed to [Running Horizon](./running.mdx)!
